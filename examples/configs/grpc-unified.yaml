# gRPC 统一架构配置
# 适用场景：高性能场景，控制平面和数据平面都使用gRPC

component:
  id: "controller-002"
  type: "controller"
  version: "1.0.0"

server:
  http:
    enabled: false  # 统一架构不使用HTTP
  
  grpc:
    enabled: true
    address: ":8443"
    max_connections: 2000
    keepalive:
      time: 30s
      timeout: 10s
      min_time: 5s

transport:
  mode: "grpc-unified"  # gRPC统一传输模式
  
  # gRPC配置
  grpc:
    enabled: true
    max_message_size: 4194304  # 4MB
    max_streams: 1000
    connection_timeout: 30s
    
    # 流控配置
    flow_control:
      initial_window_size: 65535
      initial_connection_window_size: 1048576  # 1MB

# TLS配置（gRPC需要mTLS）
tls:
  cert_file: "../../certs/controller-cert.pem"
  key_file: "../../certs/controller-key.pem"
  ca_file: "../../certs/ca-cert.pem"
  min_version: "1.3"  # gRPC推荐TLS 1.3
  mutual_auth: true
  client_auth_required: true

# 日志配置
logging:
  level: "info"
  format: "json"
  output: "stdout"
  audit_file: "./logs/audit.log"

# 数据库配置
database:
  type: "postgres"
  dsn: "postgresql://user:pass@localhost:5432/sdp?sslmode=require"
  max_connections: 50
  connection_lifetime: 3600s
  max_idle_connections: 10

# 策略配置
policy:
  default_action: "deny"
  cache_ttl: 600s
  max_cache_size: 50000

# 隧道配置
tunnel:
  default_ttl: 7200s        # 默认隧道TTL：2小时
  max_concurrent: 500       # 高并发支持
  cleanup_interval: 30s

# 会话配置
session:
  timeout: 3600s            # 会话超时：1小时
  max_idle: 900s            # 最大空闲时间：15分钟
  cleanup_interval: 60s

# 告警配置
alerting:
  enabled: true
  rules:
    - name: "cert_expiring"
      condition: "cert.days_until_expiry < 30"
      severity: "warning"
      action: "webhook"
      webhook_url: "https://alerting.example.com/webhook"
    
    - name: "high_cpu_usage"
      condition: "system.cpu_usage > 80"
      severity: "critical"
      action: "webhook"
      webhook_url: "https://alerting.example.com/webhook"

# 性能监控
monitoring:
  enabled: true
  prometheus:
    enabled: true
    port: 9090
    path: "/metrics"
  
  tracing:
    enabled: true
    jaeger_endpoint: "http://jaeger:14268/api/traces"
    sample_rate: 0.1  # 10%采样率
